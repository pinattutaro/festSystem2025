<!DOCTYPE html>
    <html lang="ja">
    <head>
      <meta charset="UTF-8">
      <title>受付用QRコードスライドショー</title>
      <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #111; color: #fff; font-family: sans-serif; }
        .slide-container { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 100%; }
        #qr-image { max-width: 80vw; max-height: 80vh; border: 10px solid #fff; border-radius: 12px; }
        #qr-info { margin-top: 20px; font-size: 2rem; font-weight: bold; }
        .instructions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;}
      </style>
    </head>
    <body>
      <div class="slide-container">
        <img id="qr-image" src="" alt="QR Code">
        <p id="qr-info"></p>
      </div>
      <div class="instructions">
        <p>← → キーでQRコードを切り替え (F11キーで全画面表示推奨)</p>
      </div>

      <script>
        // const users = [{"id":"xoU5Av","src":"./qrcodes/xoU5Av.png"},{"id":"LTJpYL","src":"./qrcodes/LTJpYL.png"},{"id":"WNpGYu","src":"./qrcodes/WNpGYu.png"},{"id":"AdjcEP","src":"./qrcodes/AdjcEP.png"},{"id":"ODpbzt","src":"./qrcodes/ODpbzt.png"},{"id":"e3tC5t","src":"./qrcodes/e3tC5t.png"},{"id":"7eCqUD","src":"./qrcodes/7eCqUD.png"},{"id":"lPlWBe","src":"./qrcodes/lPlWBe.png"},{"id":"hmp5A7","src":"./qrcodes/hmp5A7.png"},{"id":"LU7XC9","src":"./qrcodes/LU7XC9.png"}];
        let currentIndex = 0;
        let users = [];
        let uri = "";

        const qrImage = document.getElementById('qr-image');
        const qrInfo = document.getElementById('qr-info');

        function showQr(index) {
          if (users.length === 0) return;
          if (index < 0) index = 0;
          if (index >= users.length) index = users.length - 1;
          currentIndex = index;
          const user = users[index];
          qrImage.src = `./img/qrcodes/${user.id}.png`;
          qrInfo.textContent = `No. ${index + 1} / ${users.length}`;
        }

        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowRight') {
            showQr(currentIndex + 1);
          } else if (e.key === 'ArrowLeft') {
            showQr(currentIndex - 1);
          }
        });

        // WebSocket 関連
        let ws = null;

        function normalizeWsUri(u) {
          if (!u) return u;
          if (u.startsWith('ws://') || u.startsWith('wss://')) return u;
          // http/https -> ws/wss
          return u.replace(/^http/, 'ws');
        }

        function connectWebSocket() {
          if (!uri) return;
          const wsUri = normalizeWsUri(uri);
          try {
            ws = new WebSocket(wsUri);
          } catch (err) {
            console.error('WebSocket connect error', err);
            return;
          }

          ws.addEventListener('open', () => {
            console.log('WebSocket connected', wsUri);
            // // 初期状態を送る（任意）
            // sendClientAction({ type: 'hello', timestamp: Date.now() });
          });

          ws.addEventListener('message', (ev) => {
            try {
              const msg = JSON.parse(ev.data);
              console.log('WebSocket message received', msg);
            } catch (err) {
              console.warn('invalid ws message', ev.data);
            }
          });

          ws.addEventListener('close', (ev) => {
            console.warn('WebSocket closed', ev.code, ev.reason);
            ws = null;
          });

          ws.addEventListener('error', (ev) => {
            console.error('WebSocket error', ev);
            // error の後に close が来ることが多いのでここでは再接続せず待つ
          });
        }

        const main = async () => {
          try {
            const res = await fetch('https://pinattutaro.github.io/fest2025api/4u/env.json');
            const env = await res.json();
            uri = env.uri;

            const response = await fetch('./credentials.json');
            users = await response.json();
            console.log('Loaded users:', users);
          } catch (err) {
            console.warn('failed to load env.json', err);
            uri = ''; // 必要ならローカルで ws://localhost:...
          }

          // WebSocket 接続開始
          if (uri) connectWebSocket();
        };

        window.addEventListener('beforeunload', () => {
          if (ws) try { ws.close(); } catch (e) {}
        });

        main();
      </script>
    </body>
    </html>
