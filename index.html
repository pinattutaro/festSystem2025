<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Member's Card</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<style>
		@property --progress {
			syntax: '<percentage>';
			initial-value: 0%;
			inherits: true;
		}

		html, body {
			margin: 0;
			padding: 0;
			width: 100dvw;
			height: 100dvh;
			overflow: hidden;
			background: #161616;
			
			display: grid;
			grid-template-areas: "a";

			--dvh: 1dvh;
			--dvw: 1dvw;

			& > .front, .back {
				grid-area: a;

				& > .onePoint {
					width: 1em;
					position: absolute;
					bottom: calc(2.5*var(--dvh));
					right: calc(2.5*var(--dvw));
				}
			}
		}

		.front {
			width: 100dvw;
			height: 100dvh;
			padding: calc(2.5*var(--dvh)) calc(2.5*var(--dvw));
			box-sizing: border-box;				
			font-size: calc(5*var(--dvw));
			line-height: 1;
			font-family: serif;
			color: rgba(217, 165, 33, 0.3);
			position: relative;

			display: flex;
			align-items: center;

			&::before {
				width: 100%;
				height: 100%;
				content: "";
				position: absolute;
				inset: 0;
				background-image: url("img/logo.webp");
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center;
				opacity: 0.05;
				pointer-events: none;
			}

			& > .main {

				& > .uinfo {
					width: 100%;
					margin-top: 1em;
					font-size: 0.4em;

					& > .id {
						position: absolute;
						left: calc(2.5*var(--dvw));
						top: calc(2.5*var(--dvh));
					}

					& > .ui:not(.id) {
						position: relative;
						padding-top: 1em;
						height: 2em;
						box-sizing: border-box;
						border-bottom: solid 1px rgba(217, 165, 33, 0.3);						

						& > span {
							position: absolute;
							left: 8em;
						}
					}
				}
			}

			& > #qrcode {
				width: calc(20*var(--dvw));
				aspect-ratio: 1;
				position: absolute;
				top: calc(2.5*var(--dvh));
				right: calc(2.5*var(--dvw));
				opacity: 0.3;

				& > img {
					width: 100%;
					height: 100%;
				}
			}
		}

		.back {
			width: 100dvw;
			height: 100dvh;
			padding: calc(2.5*var(--dvh)) calc(2.5*var(--dvw));
			box-sizing: border-box;				
			font-size: calc(5*var(--dvw));
			line-height: 1;
			font-family: serif;
			color: rgba(217, 165, 33, 0.3);
			position: relative;

			opacity: 0;
			display: flex;
			flex-direction: column;
			/* align-items: center; */
			color: rgba(255, 250, 250,0.3);

			& > .line {
				width: 100%;
				aspect-ratio: 10;
				background: black;
				margin: 1em 0;
			}

			& > #barcode {
				width: 30%;
				/* height: 10%; */
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.1em;

				& > .bar {
					width: 100%;
					height: 1em;
					display: block;
				}

				& > .desc {
					/* height: 10%; */
					font-size: 0.3em;
					color: rgba(255, 250, 250,0.3);
				}
			}

			& > .quests {
				width: 100%;
				position: absolute;
				bottom: calc(5*var(--dvh));
				left: calc(2.5*var(--dvw));
				display: flex;
				flex-direction: column;
				/* gap: 0.5em; */

				& > .quest {
					--progress: 0%;

					color: rgba(255, 250, 250,0.3);
					width: 50%;
					/* height: 1em; */
					display: flex;
					flex-direction: row;
					align-items: center;
					align-content: center;
					font-size: 0.5em;
					line-height: 2;
					position: relative;

					&::after, &::before {
						--bar-height: 0.1em;
					}

					&::before {
						content: "";
						width: 100%;
						height: var(--bar-height);
						background: black;
						border-radius: calc(var(--bar-height)/2);
						/* box-shadow: inset 0 -0.01em 0.05em snow; */
						box-shadow: inset 0 calc(-0.05*var(--bar-height)) calc(var(--bar-height)/4) snow;
						position: absolute;
						bottom: 0;
					}

					&::after {
						content: "";
						width: var(--progress);
						height: var(--bar-height);
						background-color: snow;
						border-radius: calc(var(--bar-height)/2);
						box-shadow: 0 0 0.1em snow;
						position: absolute;
						bottom: 0;
					}

					& > .lg {
						width: 1em;
						aspect-ratio: 1;
						background-size: contain;
						background-repeat: no-repeat;
						background-position: center;
						margin-right: 0.3em;
					}

					& > .qst {
						font-size: 0.5em;
					}
				}				
			}
		}

		@media screen and (orientation: portrait) {
			.front, .back {
				--dvh: 1dvw;
				--dvw: 1dvh;

				transform: translateY(-50dvw) translateX(50dvw) rotate(90deg);
				transform-origin: 0 50%;
				width: 100dvh;
				height: 100dvw;
			}
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
	<div class="front">
		<!-- <img src="./img/logo.webp" alt="logo" class="onePoint"> -->
		<div class="main">
			Member's Card
			<div class="uinfo">
				<div class="ui id">No. ------</div>
				<!-- <div class="ui name">Name<span>user0000</span></div> -->
				<div class="ui level">Level<span>--</span></div>
				<div class="ui cash">Cash<span>--</span></div>
			</div>
		</div>
		<div id="qrcode" class="qrcode"></div>
	</div>
	<div class="back">
		<img class="onePoint" src="./img/logo.webp" alt="logo">
		<div class="line"></div>

		<div id="barcode">
			<svg class="bar" preserveAspectRatio="none"></svg>
			<span class="desc"></span>
		</div>

		<div class="quests">
			<div class="quest" id="dungeon">
				<div class="lg material-symbols-outlined">castle</div>
				<div class="qst">aaaaaa</div>
			</div>
			<div class="quest" id="casino">
				<div class="lg material-symbols-outlined">poker_chip</div>
				<div class="qst">aaaaaaaaa</div>
			</div>
			<div class="quest" id="code_editor">
				<div class="lg material-symbols-outlined">code_blocks</div>
				<div class="qst">aaaaaaa</div>
			</div>			
		</div>

	</div>
</body>
<script>
	const url = window.location.href;
	console.log("Generating QR code for URL:", url);

	const qr = new QRCode(document.getElementById("qrcode"), {
		text: url,
		// width: 256,
		// height: 256,
		colorDark: "#c0c0c0",
		colorLight: "#161616",
		correctLevel: QRCode.CorrectLevel.H
	});

	let state = true;
	const frontElem = document.querySelector(".front");
	const backElem = document.querySelector(".back");
	document.body.addEventListener("click", () => {
		state = !state;
		if (state) {
			frontElem.style.opacity = "1";
			backElem.style.opacity = "0";			
		} else {
			frontElem.style.opacity = "0";
			backElem.style.opacity = "1";						
		}
	});

	const idElem = document.querySelector(".uinfo .id");
	const levelElem = document.querySelector(".uinfo .level span");
	const cashElem = document.querySelector(".uinfo .cash span");

	const barcodeElem = document.querySelector("#barcode");

	const main = async () => {
		const envjson = await fetch("https://pinattutaro.github.io/fest2025api/4u/env.json").then(res => res.json());
		const uri = envjson.uri;

		console.log("Fetched env.json:", envjson);

		const params = new URLSearchParams(window.location.search);
		const query = {};
		for (const [key, value] of params.entries()) {
			query[key] = value;
		}
		// console.log(query);

		// login
		const login = await fetch(`${uri}/api/auth/login`, {
			method: "POST",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify(query)
		});

		// console.log(login.status);
		const loginData = await login.json();
		// console.log(loginData);

		if (login.status !== 200) {
			console.error("Login failed with status:", login.status);
			// idElem.textContent = "No. ----";
			// levelElem.textContent = "--";
			// cashElem.textContent = "--";	
			return;		
		}

		const userData = loginData.data.user;
		const exp = userData.experience;
		const token = loginData.data.token;

		idElem.textContent = `No. ${userData.id}`;
		levelElem.textContent = `${Math.floor((-1 + Math.sqrt(1+8*exp))/2)}`
		cashElem.textContent = userData.currency;

		// generate barcode
		JsBarcode(barcodeElem.querySelector(".bar"), String(userData.id), {
			format: "CODE128",
			lineColor: "#c0c0c0",
			background: "#161616",
			// width: 2,
			// height: 50,
			displayValue: false,
			margin: 0
		});
		barcodeElem.querySelector(".desc").textContent = `${userData.id}`;

		// init user
		const uinfo = await fetch(`${uri}/api/users/me`, {
			method: "POST",
			headers: {
				'Authorization': `Bearer ${token}`
			}
		});

		if (uinfo.status !== 200) {
			console.error("Fetching user info failed with status:", uinfo.status);
			alert("ユーザー情報の取得に失敗しました。\nページをリフレッシュしてください。");
			return;		
		}

		const uinfoData = (await uinfo.json()).data.user;
		console.log("Fetched user info:", uinfoData);

		const quests = uinfoData.activeQuests;
		const flags = uinfoData.flags;

		// console.log("Active quests:", quests);

		["dungeon", "casino", "code_editor"].forEach(q => {
			const questElem = document.getElementById(q);
			const questData = quests[q];

			const {description, questId, startValue, targetValue} = questData;
			// console.log(description);
			const currentValue = flags[questId];
			const progress = `${Math.floor(100 * (currentValue - startValue) / (targetValue - startValue))}%`;
			console.log(`${q} progress:`, progress);

			questElem.querySelector(".qst").textContent = description;
			questElem.style.setProperty("--progress", progress);

		})
	}

	main();
</script>
</html>
