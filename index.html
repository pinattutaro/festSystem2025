<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Member's Card</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			/* height: 100%; */
			width: 100dvw;
			height: 100dvh;
			/* padding: 2.5dvh 2.5dvw; */
			overflow: hidden;
			background: #161616;
			/* color: #c0c0c0; */
			/* background-image: url("img/logo.webp");
			background-size: contain;
			background-repeat: no-repeat;
			background-position: center; */
			
			/* body::before {
				width: 100%;
				height: 100%;
				content: "";
				position: absolute;
				inset: 0;
				background-image: url("img/logo.webp");
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center;
				opacity: 0.05;
			} */
		}

		.front {
			--dvh: 1dvh;
			--dvw: 1dvw;

			width: 100dvw;
			height: 100dvh;
			padding: calc(2.5*var(--dvh)) calc(2.5*var(--dvw));
			box-sizing: border-box;
			/* font-size: 5dvw; */
			font-size: calc(5*var(--dvw));
			line-height: 1;
			font-family: serif;
			color: rgba(217, 165, 33, 0.3);
			display: flex;
			align-items: center;
			position: relative;

			&::before {
				width: 100%;
				height: 100%;
				content: "";
				position: absolute;
				inset: 0;
				background-image: url("img/logo.webp");
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center;
				opacity: 0.05;
				pointer-events: none;
			}

			& > .main {

				& > .uinfo {
					width: 100%;
					margin-top: 1em;
					font-size: 0.4em;

					& > .id {
						position: absolute;
						left: calc(2.5*var(--dvw));
						top: calc(2.5*var(--dvh));
					}

					& > .ui:not(.id) {
						position: relative;
						padding-top: 1em;
						height: 2em;
						box-sizing: border-box;
						border-bottom: solid 1px rgba(217, 165, 33, 0.3);						

						& > span {
							position: absolute;
							left: 8em;
						}
					}
				}
			}

			& > #qrcode {
				width: calc(20*var(--dvw));
				aspect-ratio: 1;
				position: absolute;
				top: calc(2.5*var(--dvh));
				right: calc(2.5*var(--dvw));
				opacity: 0.3;

				& > img {
					width: 100%;
					height: 100%;
				}
			}
		}

		@media screen and (orientation: portrait) {
			body::before {
				/* transform: rotate(90deg); */
			}

			.front {
				--dvh: 1dvw;
				--dvw: 1dvh;

				transform: translateY(-50dvw) translateX(50dvw) rotate(90deg);
				transform-origin: 0 50%;
				width: 100dvh;
				height: 100dvw;
			}
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
	<div class="front">
		<div class="main">
			Member's Card
			<div class="uinfo">
				<div class="ui id">No. 123456</div>
				<!-- <div class="ui name">Name<span>user0000</span></div> -->
				<div class="ui level">Level<span>50</span></div>
				<div class="ui cash">Cash<span>100</span></div>
			</div>
		</div>
		<div id="qrcode" class="qrcode"></div>
	</div>
</body>
<script>
	const url = window.location.href;
	console.log("Generating QR code for URL:", url);

	const qr = new QRCode(document.getElementById("qrcode"), {
		text: url,
		// width: 256,
		// height: 256,
		colorDark: "#c0c0c0",
		colorLight: "#161616",
		correctLevel: QRCode.CorrectLevel.H
	});

	const idElem = document.querySelector(".uinfo .id");
	const levelElem = document.querySelector(".uinfo .level span");
	const cashElem = document.querySelector(".uinfo .cash span");

	const main = async () => {
		const envjson = await fetch("https://pinattutaro.github.io/fest2025api/4u/env.json").then(res => res.json());
		const uri = envjson.uri;

		console.log("Fetched env.json:", envjson);

		const params = new URLSearchParams(window.location.search);
		const query = {};
		for (const [key, value] of params.entries()) {
			query[key] = value;
		}
		// console.log(query);

		const login = await fetch(`${uri}/api/auth/login`, {
			method: "POST",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify(query)
		});

		// console.log(login.status);
		const loginData = await login.json();
		// console.log(loginData);

		if (login.status === 200) {
			const userData = loginData.data.user;
			const exp = userData.experience;

			idElem.textContent = `No. ${userData.id}`;
			// levelElem.textContent = userData.level;
			levelElem.textContent = Math.floor((-1 + Math.sqrt(1+8*exp))/2);
			cashElem.textContent = userData.currency;
		} else {
			console.error("Login failed with status:", login.status);
			idElem.textContent = "No. ----";
			levelElem.textContent = "--";
			cashElem.textContent = "--";
		}
	}

	main();
</script>
</html>
