<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=390, initial-scale=0.5">
	<title>Member's Card</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
	<style>
		@property --progress {
			syntax: '<percentage>';
			initial-value: 0%;
			inherits: true;
		}

		:root {
			--text-opacity: 0.5;
		}

		html, body {
			margin: 0;
			padding: 0;
			width: 100dvw;
			height: 100dvh;
			overflow: hidden;
			background: #161616;
			
			display: grid;
			grid-template-areas: "a";
			/* place-items: center; */

			--dvh: 1dvh;
			--dvw: 1dvw;

			& > .front, .back {
				grid-area: a;

				& > .onePoint {
					width: 1em;
					position: absolute;
					bottom: calc(2.5*var(--dvh));
					right: calc(2.5*var(--dvw));
					z-index: 1;
				}
			}
		}

		html {
			background-color: black;
		}

		body {
			border-radius: 1em;
		}

		#qrLarge {
			display: none;
			width: calc(90*var(--dvh));
			aspect-ratio: 1;
			/* grid-area: a; */
			/* transform: translate(-50%, -50%); */
			cursor: pointer;
			z-index: 2;
			position: absolute;
			top: calc(5*var(--dvh));
			right: calc(2.5*var(--dvw));

			& > img {
				width: 100%;
				height: 100%;
			}
		}

		.front {
			width: 100dvw;
			height: 100dvh;
			padding: calc(2.5*var(--dvh)) calc(2.5*var(--dvw));
			box-sizing: border-box;				
			font-size: calc(5*var(--dvw));
			line-height: 1;
			font-family: serif;
			color: rgba(217, 165, 33, var(--text-opacity));
			position: relative;

			display: flex;
			align-items: center;

			&::before {
				width: 100%;
				height: 100%;
				content: "";
				position: absolute;
				inset: 0;
				background-image: url("img/logo.webp");
				background-size: contain;
				background-repeat: no-repeat;
				background-position: center;
				opacity: 0.05;
				pointer-events: none;
			}

			& > .main {

				& > .uinfo {
					width: 100%;
					margin-top: 1em;
					font-size: 0.4em;

					& > .id {
						position: absolute;
						left: calc(2.5*var(--dvw));
						top: calc(2.5*var(--dvh));
					}

					& > .ui:not(.id) {
						position: relative;
						padding-top: 1em;
						height: 2em;
						box-sizing: border-box;
						border-bottom: solid 1px rgba(217, 165, 33, var(--text-opacity));						

						& > span {
							position: absolute;
							left: 8em;
						}
					}
				}
			}

			.qrcode {
				background-size: cover;
				background-position: center;
				background-repeat: no-repeat;
				opacity: var(--text-opacity);
			}

			& > #qrcode {
				width: calc(20*var(--dvw));
				aspect-ratio: 1;
				position: absolute;
				top: calc(2.5*var(--dvh));
				right: calc(2.5*var(--dvw));

				/* align-self: flex-end;
				justify-self: flex-end; */
				opacity: var(--text-opacity);
				z-index: 1;

				& > img {
					width: 100%;
					height: 100%;
				}

				&:hover {
					position: absolute;
					width: calc(90*var(--dvh));
					aspect-ratio: 1;
					top: calc(5*var(--dvh));
					left: calc(50*var(--dvw) - 45*var(--dvh));
					opacity: 1;
				}
			}
		}

		.back {
			width: 100dvw;
			height: 100dvh;
			padding: calc(2.5*var(--dvh)) calc(2.5*var(--dvw));
			box-sizing: border-box;				
			font-size: calc(5*var(--dvw));
			line-height: 1;
			display: none;
			font-family: serif;
			color: rgba(217, 165, 33, var(--text-opacity));
			position: relative;

			opacity: 1;
			/* display: flex; */
			flex-direction: column;
			/* align-items: center; */
			color: rgba(255, 250, 250,var(--text-opacity));

			& > .line {
				width: 100%;
				aspect-ratio: 10;
				background: black;
				margin: 1em 0;
				pointer-events: none;

			}

			& > #barcode {
				width: 50%;
				/* height: 10%; */
				display: flex;
				flex-direction: column;
				align-items: center;
				gap: 0.1em;

				& > .bar {
					width: 100%;
					height: 1em;
					display: block;
				}

				& > .desc {
					/* height: 10%; */
					font-size: 0.3em;
					color: rgba(255, 250, 250,var(--text-opacity));
				}
			}

			& > .quests {
				width: 100%;
				position: absolute;
				bottom: calc(5*var(--dvh));
				left: calc(2.5*var(--dvw));
				display: flex;
				flex-direction: column;
				/* gap: 0.5em; */

				& > .quest {
					--progress: 0%;

					color: rgba(255, 250, 250,var(--text-opacity));
					width: 50%;
					/* height: 1em; */
					display: flex;
					flex-direction: row;
					align-items: center;
					align-content: center;
					font-size: 0.5em;
					line-height: 2;
					position: relative;

					&::after, &::before {
						--bar-height: 0.1em;
					}

					&::before {
						content: "";
						width: 100%;
						height: var(--bar-height);
						background: black;
						border-radius: calc(var(--bar-height)/2);
						/* box-shadow: inset 0 -0.01em 0.05em snow; */
						box-shadow: inset 0 calc(-0.05*var(--bar-height)) calc(var(--bar-height)/4) snow;
						position: absolute;
						bottom: 0;
					}

					&::after {
						content: "";
						width: var(--progress);
						height: var(--bar-height);
						background-color: snow;
						border-radius: calc(var(--bar-height)/2);
						box-shadow: 0 0 0.1em snow;
						position: absolute;
						bottom: 0;
					}

					& > .lg {
						width: 1em;
						aspect-ratio: 1;
						background-size: contain;
						background-repeat: no-repeat;
						background-position: center;
						margin-right: 0.3em;
					}

					& > .qst {
						font-size: 0.5em;
					}
				}				
			}
		}

		@media screen and (orientation: portrait) {
			.front, .back {
				--dvh: 1dvw;
				--dvw: 1dvh;

				transform: translateY(-50dvw) translateX(50dvw) rotate(90deg);
				transform-origin: 0 50%;
				width: 100dvh;
				height: 100dvw;
			}
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
	<div id="qrLarge" class="qrcode"></div>
	<div class="front">
		<!-- <img src="./img/logo.webp" alt="logo" class="onePoint"> -->
		<div class="main">
			Member's Card
			<div class="uinfo">
				<div class="ui id">No. ------</div>
				<!-- <div class="ui name">Name<span>user0000</span></div> -->
				<div class="ui level">Level<span>--</span></div>
				<div class="ui cash">Cash<span>--</span></div>
			</div>
		</div>
		<div id="qrcode" class="qrcode"></div>
	</div>
	<div class="back">
		<img class="onePoint" src="./img/logo.webp" alt="logo">
		<div class="line"></div>

		<div id="barcode">
			<svg class="bar"></svg>
			<span class="desc"></span>
		</div>

		<div class="quests">
			<div class="quest" id="dungeon">
				<div class="lg material-symbols-outlined">castle</div>
				<div class="qst">----------</div>
			</div>
			<div class="quest" id="casino">
				<div class="lg material-symbols-outlined">poker_chip</div>
				<div class="qst">----------</div>
			</div>
			<div class="quest" id="code_editor">
				<div class="lg material-symbols-outlined">code_blocks</div>
				<div class="qst">----------</div>
			</div>			
		</div>

	</div>
</body>
<script>
	const url = window.location.href;
	console.log("Generating QR code for URL:", url);

	let qrState = true;
	const qrLargeElem = document.getElementById("qrLarge");
	const qrcodeElem = document.getElementById("qrcode");
	function openQrLarge(e){
		console.log("QR code clicked / touched");
		// prevent the body click handler from toggling the card
		if(e && e.stopPropagation) e.stopPropagation();
		qrState = false;
		// qrLargeElem.style.display = "block";
	}
	// support click, pointer and touch for mobile
	qrcodeElem.addEventListener("click", openQrLarge);
	qrcodeElem.addEventListener("pointerup", openQrLarge);
	qrcodeElem.addEventListener("touchend", (e) => { e.preventDefault(); openQrLarge(e); });

	let state = true;
	const frontElem = document.querySelector(".front");
	const backElem = document.querySelector(".back");
	document.body.addEventListener("click", (e) => {
		// If the large QR is open (qrState === false), close it and consume the event
		if (!qrState) {
			qrLargeElem.style.display = "none";
			qrState = true;
			if (e && e.stopPropagation) e.stopPropagation();
			return;
		}

		// otherwise toggle front/back view
		qrLargeElem.style.display = "none";
		state = !state;
		if (state) {
			frontElem.style.display = "flex";
			backElem.style.display = "none";
			main();            
		} else {
			frontElem.style.display = "none";
			backElem.style.display = "flex";                     
		}
	});

	// allow tapping the large QR to close it (mobile friendly)
	qrLargeElem.addEventListener('click', (e) => {
		qrLargeElem.style.display = 'none';
		qrState = true;
		if (e && e.stopPropagation) e.stopPropagation();
	});
	qrLargeElem.addEventListener('touchend', (e) => { e.preventDefault(); qrLargeElem.style.display = 'none'; qrState = true; });

	const logoElem = document.querySelector(".onePoint");
	let clicked = 0;
	logoElem.addEventListener("click", (e) => {
		e.stopPropagation();
		clicked += 1;
		clicked %= 5;
		const opacity = 0.5 + 0.1 * clicked;
		document.body.style.setProperty("--text-opacity", opacity);
	});

	const idElem = document.querySelector(".uinfo .id");
	const levelElem = document.querySelector(".uinfo .level span");
	const cashElem = document.querySelector(".uinfo .cash span");

	const barcodeElem = document.querySelector("#barcode");

	let uri = "";
	let apiKey = "";

	const init = async () => {
		const envjson = await fetch("https://pinattutaro.github.io/fest2025api/4u/env.json").then(res => res.json());
		uri = envjson.uri;
		apiKey = envjson["x-api-key"];

		console.log("Fetched env.json:", envjson);

		const params = new URLSearchParams(window.location.search);
		const query = {};
		for (const [key, value] of params.entries()) {
			query[key] = value;
		}

		if (!query.id) {
			main();
			return;
		}

		const login = await fetch(`${uri}/api/auth/login`, {
			method: "POST",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({...query, qr: true })
		});

		if (login.status == 200) {
			localStorage.setItem("id", query.id);
			localStorage.setItem("id2", query.id2);

			const url = new URL(window.location.href);
			url.search = '';
			window.history.replaceState({}, document.title, url.toString());
			main();
			return;
		}

		alert("Login failed.");
	}

	const login = async (id, id2) => {
		const res = await fetch(`${uri}/api/auth/login`, {
			method: "POST",
			headers: {
				"Content-Type": "application/json"
			},
			body: JSON.stringify({ id, id2, qr: false })
		});

		const data = await res.json();
		console.log("Login response:", data);
		return data;
	}

	const uinfo = async (token) => {
		console.log("Fetching user info with token:", token);
		const res = await fetch(`${uri}/api/users/me`, {
			method: "POST",
			headers: {
				"Authorization": `Bearer ${token}`
			}
		});

		const data = await res.json()
		console.log("User info response:", data);
		return data;
	}

	const main = async () => {
		const id = localStorage.getItem("id");
		const id2 = localStorage.getItem('id2');

		if (!id || !id2) {
			console.log("No ID found in localStorage.");
			return;
		}

		const token = (await login(id, id2)).data.token;

		const user = (await uinfo(token)).data.user;
		const exp = user.experience;
		const cash = user.currency;
		const quests = user.activeQuests;
		const flags = user.flags;

		idElem.textContent = `No. ${id}`;
		levelElem.textContent = `${Math.floor((-1 + Math.sqrt(1+8*exp))/2)}`;
		cashElem.textContent = `${cash}`;

		const qrcodes = document.querySelectorAll(".qrcode");
		qrcodes.forEach(elem => {
			elem.style.backgroundImage = `url("./img/qrcodes/${id}.png")`;
		});

		JsBarcode(barcodeElem.querySelector(".bar"), `https://go.com?id=${id}`, {
			format: "CODE128",
			lineColor: "#c0c0c0",
			background: "#161616",
			displayValue: false,
			margin: 0
		});

		["dungeon", "casino", "code_editor"].forEach(q => {
			const questElem = document.getElementById(q);
			const questData = quests[q];

			const {description, questId, startValue, targetValue} = questData;
			// console.log(description);
			const currentValue = flags[questId];
			const progress = `${Math.floor(100 * (currentValue - startValue) / (targetValue - startValue))}%`;
			console.log(`${q} progress:`, progress);

			questElem.querySelector(".qst").textContent = description;
			questElem.style.setProperty("--progress", progress);

		});
	}

	init();
</script>
</html>